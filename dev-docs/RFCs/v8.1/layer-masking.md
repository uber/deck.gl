# RFC: Layer Masking

* Authors: Ravi Akkenapally
* Date: January 14, 2020
* Status: **Draft**

> NOTE: this RFC proposes using luma.gl shader module `texturefilter` that is actively worked on at the time of this writing, corresponding luma.gl [RFC](https://github.com/uber/luma.gl/pull/1350)


## Overview

This RFC proposes new `MaskEffect` for performing layer masking. Mask is represented by a `Texture` object, that can be either directly provided or generated by one or more other layers. When a layer is masked (i.e. `MaskEffect` is applied), objects that fall outside of the masked region can be either be discarded or their attributes (color, size) can be changed. The mask is expected to be in world-space and verifying an object inside or outside is also performed at world space.


## Proposal

Sample code to perform masking on a `ScatterplotLayer` to a `SolidPolygonLayer` that is rendering a complex polygon.

```js
import DeckGL from '@deck.gl/react';
import {GeoFilterEffect} from '@deck.gl/core';

const maskEffect = new MaskEffect({precision: 0.8});

// ...

const App = (data) => (
  <DeckGL
    layers={[
      new SolidPolygonLayer({
        data: [
              [[0, 0], [0, 2], [2, 2], [2, 0], [0, 0]],
              [[0, 0], [0, 1], [1, 1], [1, 0], [0, 0]]
            ],
        // MaskEffect prop
        generateMask: true
        // ...
      })
      // Layer that gets filtered out
      new ScatterplotLayer({
        data,
        // MaskEffect prop
        applyMask: true
      })
    ]}
    // MaskEffect
    effects={[maskEffect]}
  >
  // ... map
  </DeckGL>
);

```

### New layer props

- `generateMask` : when set, corresponding layer will contribute to the mask texture.
- `applyMask` : When set, layer data will be filtered out as per the mask.
- `maskHighlightColor` : Provided `applyMask` is set, by default objects outside of the masked region are discarded, when this prop is set to a RGBA color, instead of discarding the objects, this color is used as highlight color for objects inside the mask.
- `maskBoundingBox` : Axis aligned bounding box to create the mask texture.

### MaskEffect

A new effect class, `MaskEffect` will be added. It optionally takes a mask texture, bounding box. If not provided theses are generated based on layers attributes which have `generateMask` prop is set. All layers, which have `applyMask` is set will be masked by the texture mask.


This `Effect` operates in two different steps. The constructor, takes `precision` that defines the size of the texture to be used for generating the mask.

#### Generating Texture Mask

If the mask texture is not provided, this `Effect` generates the required texture. Internally it creates a new render pass to render data into an offline an Framebuffer.

During pre render pass:
- All layers are processed, and if a layer has `generateMask` prop set, a bounding box of its data is calculated (optionally can be provided by the layer).
- All above bounding boxes are merged at each step.
- This bounding box is used to setup Orthographic projection and layers are rendered to an offline Framebuffer.

It is expected the layers are rendered in 2D world-space, hence not all layers can be used to generate this texture. For example, `PolygonLayer` ( with `extruded` prop set to false) is a good candidate, at the same time, `IconLayer` is not a good candidate.


#### Performing Masking Operation

For all the layers, that have `applyMask` set, mask operation is performed to either discard objects outside of region defined the mask or highlight the objects that are inside.

Above generated `Texture` and `bounding box` are used to perform masking operation. We will define a new shader module `textureMask` that depends on luma.gl's `textureFilter` module. This shader module will be used to process, object's position attribute to identify which objects are inside and which objects are outside of the masked region.

Vertex and Fragment shader parts of the module contain, `maskEffect_isMasked` varying and any uniforms to change layer's attributes (such as color). And following injects will be defined

- `vs:#main-start` : To perform sampling and set `maskEffect_isMasked`.
- `vs:DECKGL_FILTER_SIZE` : To set object size to 0 if the object is outside.
- `fs:DECKGL_FILTER_COLOR` : To discard the fragments if filter value is 0. This can also be used update the color of the fragment if it is inside the region.


## Open Questions

Q: Not all layers can be used to generate the mask. Like `ArcLayer`, `IconLayer`, etc are not a suitable candidates for generating the mask. How do we handle this?

A: We can list set of layers and document them, or we can add static method for each layer that determines, if it can be used for mask generation.

Q: Original intention is to generate mask texture in 2D world space, how do we handle props that are not in world space, like `radiusPixels` etc.

Q: We also require computation of bounding box (of position attribute) if not provided, how do generate this?

A: Add utility method for `AttributeManager`, that can handle all types of attributes (Buffer, Binary etc).
